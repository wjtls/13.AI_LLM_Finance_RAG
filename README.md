Finance RAG_RL 모델

view 이미지 : ![image](https://github.com/user-attachments/assets/c610920c-6ee2-48eb-9e58-cd2c3e86d613)



1. Finance RAG_RL 모델 (분석, 최적행동 추천 및 QA모델) : 
미국 금융 시장의 실시간 이슈, 경제지표, 주가를 활용하여 보고서 작성 및 사용자 QA 							
   1) 사용처 , 용도, 성과 (개인프로젝트로 개발) 	
     1] 용도 : 주변인(부모님, 친구들)의 주식관련 QA를 하는과정에서 
       정보 서치, 매매의사결정을 분석해주고 답변하는 과정의 번거로움 발생.  	
       추천, QA, 분석, 매매 과정을 모두 자동화하고, 개인적으로도 트레이딩에 
       사용하고자 개인 프로젝트로 개발	

     2] 개발사유 : 휴식기동안 진행했던 RAG 기반 금융QA모델은 이슈분석 기반으로 
       사용자들에게 QA하는 모델이었고, 사용자들의 실제 요구사항인 “최적의 매매시점”을         잘 추천 하는것에는 어려움이 있었습니다. 따라서 강화학습기반의 최적행동 추천 
       기능을 추가하고 시장상황에 맞는 청크를 리트리브하여 모델을 개선하였습니다.
								
   2] 성과 : 전진분석시 5개월간 수익 20% 달성 					
          실전매매시 참고하여 5개월간 수익 15% 달성 
          (참고용으로 사용했으며 자동매매 기능은 테스트중입니다.)			


2. 도식
   1) 데이터를 실시간 수집하고 vector DB에 인서트
     ![image](https://github.com/user-attachments/assets/f84df0d7-1bb6-4eed-bae0-57e475baeb69)
   2) AI predictor 와 Modular RAG 모델의 응답생성 (사용자 QA 또는 보고서)
     ![image](https://github.com/user-attachments/assets/beffd7e5-6805-44c9-9b57-6c8e4e20f84e)
   3) 결과를 웹에 가시화 (AI의 실시간 매매의사결정 추천, QA, 보고서)
     ![image](https://github.com/user-attachments/assets/c610920c-6ee2-48eb-9e58-cd2c3e86d613)
      1] 사용자 질문 : “미국 시장 분석좀 해줘” 의 응답결과
      2] Finance AI 모델의 참고 데이터 (우측 생성 응답) : 미국의 실시간 이슈, 과거이슈, 
                                   AI predictor의 기술적분석,경제지표,외환정보 등을 참고
      3] predictor AI 응답(왼쪽 그래프) : 기술적 분석 기반의 최적매매의사결정을 내리며 
                                   붉은색은 매수행동 추천, 파란색은 매도 행동 추천	
      4] Finance AI모델의 응답 : AI predictor의 행동추천과 Modular RAG 모델의 분석을 
                               결합(목표 :기술적분석과 기본적분석을 모두 실행하는것)
      5] 왼쪽 웹사진에서 백테스트및 실전 전진분석 기간 : 2024년-11월-12일 까지 
                       백테스트 기간이며, 이후부터 최근(실시간)까지는 전진분석,실전 기간
      6] 매매행동 추천과 보고서 생성은 60분마다 실행합니다




3. 장착된 Agent 종류  	
     1] Agentic LLM (langGraph , Modular RAG 기반): 미국 금융 시장의 실시간 
       기술적분석,이슈,경제지표,주가를 활용하여 보고서 작성 및 사용자 QA 						
     2] AI predictor (강화학습,딥러닝 기반) : 예측 및 최적의사결정 능력 향상을 
       목적으로 개발하여 장착

                
4 사용 기술 <br>								
    1] LLM,RAG 연관 : langchain, langGraph, Advanced RAG , Modular RAG ,Vector DB (pineconeDB,Qdrant,Elasticsearch), reranker, query decomposition, Agentic tool)       
    2] RL,DL,파인튜닝 연관 : pytorch, 강화학습(Reinforcement learning),머신러닝, 딥러닝			

    
5. 문제인식 및 시행착오							
    1) 상황 1 : 금융 도메인 특화모델 개발을 위해 파인튜닝을 시도했으나 학습시간 
       및 학습비용 과다소모, 실시간 정보를 고려하기위해 Online RL 기반의 파인튜닝시 
       최종 응답까지의 딜레이 발생 	
       해결 방안 : peft, Qlora등 양자화 및 여분의 신경망을 미세조정하는 방식으로 
                 학습비용 감소를 도모 ,편향 감소를 위한 파인튜닝 RL 알고리즘 
                 (ORPO , SFT 적용 preference 정렬 ,보상함수 조절등)							
    2) 상황 2: 파인튜닝 알고리즘을 개선해도 클라우드,로컬 GPU에서 시뮬레이션 기반 
       파인튜닝의 학습시간,비용,QA를 위한 프로세스에서 응답까지 딜레이는 여전히 발생
       해결 방안 : RAG를 통해 실시간,과거 금융데이터를 가져오고 매매 의사결정 추천, 
                  보고서작성, QA를 모두 실행							
    4) 상황 3: 								
       문제 상황 - 할루시네이션 발생 1 : 사용자 질문이 모호한 경우	
       문제 상황 - 할루시네이션 발생 2 : 웹정보 검색 키워드가 부정확하거나 , 
                                        웹정보가 사용자 질문과 연관없는 경우 	
       문제 상황 - 할루시네이션 발생 3 : 실시간 정보를 사용해야되는 응답에 
                                        DB의 과거 이슈를 사용하는 경우							
       해결 방안 : query breaker ->사용자 질문의 서브쿼리를 n개생성하여 질문을 세분화
       해결 방안 : raw 데이터에 메타 필터링과 메타값을 추가 
                  (header 부여, 청크마다 타이틀 부여) 하여 실시간 정보를 필터하고
                  청크와 query에서 관련있는 청크의 유사도를 높인다
       해결 방안 : 자가 쿼리 개선, 웹서칭 개선 방법 적용 -> 할루시네이션이 
                  발생하면 langGraph 판단노드에서 자가 응답 개선을 지시한다											

    5) 상황 4:								
       문제 상황 - 현재 task의 state를 고려하지 못함 : 금융(주식) 질문
       (ex : '지금 테슬라 오를까?')와 같이 예측,최적판단이 요구되는 QA에서 
            유사한 청크를 리트리브 하는것만으로는 사용자가 만족하는 응답이 어렵다)									
       해결방안 : 현 시장의 상황을 벡터로 표시하여 청크마다 기입하고, 리트리브할때 
                 질문시점의 시장상황과 유사한 상황을 가진 청크를 리트리브한다. -> 
                 유사한 과거 상황을 고려하는 효과	
							
    6) 상황 5:								
       문제 상황 - 예측/판단력 부족 : RAG는 hybrid(sementic + sparse)서치를통한 
       임베딩 벡터 유사성을 기반으로 청크를 가져오는 open book 방법론이므로 
       실시간정보를 토대로 그럴듯한 답변은 가능하지만 도메인
       (의사결정 및 행동 추천,금융분석등)을 '잘' 하는것과는 거리가있다.								
       해결방안 : 상황2에서 문제점과 상황4를 해결하기 위해 별도로 강화학습
                 (시뮬레이션 기반 매매 행동최적화) 모델을 학습. RL 알고리즘의 
                 가중치를 LLM의 Actor(Transformer)에 업데이트하지않고 별도의 
                 Actor와 Critic 신경망을 업데이트 -> 이로인해 시장 상황에대한 
                 예측력을 갖추면서 적은 리소스(single GPU : rtx 3070ti , cpu: i9-12900)
                 으로 Finance 모델(QA,추천,예측,분석) 운용 가능
       
5. 개발(개인프로젝트) 추가 내용						
    1) 프로젝트 수행인원 : 본인(조효신) 1명의 개인 프로젝트	
    2) 프로젝트 업무 내용 						
      1] RAG 기반 금융 분석 및 QA 모델 개발 (LLM RAG, langchain, langGraph 기반)
      2] AI 행동최적화 및 추천,예측 모델 개발 (강화학습, 딥러닝 , pytorch기반)
      3] 웹서버 개발 (Django , html  -> 웹개발 경험이 한번도 없는 관계로 오픈소스를 참고하여 개발)	    
            4] 모델과 웹을 api로 연결하여 정보를 웹에 표시
    3) 사용 툴
       1] 개발 : pycharm, VS코드, mobaXterm ssh서버(노트북 작업시)



					
6. 사용 데이터 (기술적 지표 + 미국 경제지표 + 미국 이슈)	
	1. 가격 데이터 : 미국 1분봉 ETF, 주식, index (2008년~현재) 수집 	
	2. 경제 지표 데이터 : FRED 30~50년치 미국 경제지표(CPI, PMI, 주택구매지수 등) 수집
	3. 외환,미국회사주가 변동 데이터 수집
	4. 이슈 데이터 
	  1 ) 미국 금융 top 이슈 수집 				
	  2 ) 현시장 상황 핵심 이슈 수집	
	5. 재무 데이터 	
	6. 경제 캘린더 : 미국의 경제지표 발표일 정리 데이터									
